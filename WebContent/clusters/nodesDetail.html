<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>PaaS-TA Container</title>
    <link href="../resources/css/layout.css" rel="stylesheet" type="text/css" />
</head>
<body>
	<div id="wrap">
		<!-- Header -->
		<header>
			<div>
				<!-- logo -->
				<h1>
					<a href="../index.html"><img src="../resources/img/logo.png" alt="PaaS-TA 로고" /></a>
				</h1>
				<!-- menu -->
				<div>
					<!-- title -->
					<h3>
						<a href="javascript:;" class="nameTop">ALL</a>
						<ul class="nameSpace scroll02">
						</ul>
					</h3>
					<!-- member-menu -->
					<div>
						<a href="javascript:;" id="logout">로그아웃</a>
						<div id="setInfo">
							<a href="javascript:;" id="userSetting">환경설정</a>
						</div>
					</div>
				</div>
			</div>
		</header>
		<!-- // Header -->
		<!-- container -->
		<div id="container">
			<!-- aside -->
			<aside>
				<nav>
					<ul>
						<li class="plus">
							<a href="javascript:;" class="dep01">Clusters</a>
							<ul class="sub">
								<li><a href="namespaces.html">Namespaces</a></li>
								<li><a href="nodes.html">Nodes</a></li>
							</ul>
						</li>
						<li class="plus">
							<a href="javascript:;" class="dep01">Workloads</a>
							<ul class="sub">
								<li><a href="../workloads/deployments.html">Deployments</a></li>
								<li><a href="../workloads/pods.html">Pods</a></li>
								<li><a href="../workloads/replicaSets.html">Replica Sets</a></li>
							</ul>
						</li>
						<li>
							<a href="../services/services.html" class="dep01">Services</a>
						</li>
						<li class="plus">
							<a href="javascript:;" class="dep01">Storages</a>
							<ul class="sub">
								<li><a href="../storages/persistentVolumes.html">Persistent Volumes</a></li>
								<li><a href="../storages/persistentVolumeClaims.html">Persistent Volume Claims</a></li>
								<li><a href="../storages/storageClasses.html">Storage Classes</a></li>
							</ul>
						</li>
						<li class="plus">
							<a href="javascript:;" class="dep01">Managements</a>
							<ul class="sub">
								<li><a href="../managements/users.html">Users</a></li>
								<li><a href="../managements/roles.html">Roles</a></li>
								<li><a href="../managements/resourceQuotas.html">Resource Quotas</a></li>
								<li><a href="../managements/limitRanges.html">Limit Ranges</a></li>
							</ul>
						</li>
					</ul>
				</nav>
			</aside>
			<!-- // aside -->
			<!-- Content -->
			<div id="content" class="sub-page clusters">
				<article class="location">
					<ul>
						<li><a href="../index.html">Overview</a></li>
						<li><a href="namespaces.html">Clusters</a></li>
						<li><a href="nodes.html">Nodes</a></li>
					</ul>
				</article>
				<article class="base detail">
					<div class="notice">
						<h4>Details</h4>
						<div class="table_style01">
							<table>
								<caption>details</caption>
								<colgroup >
									<col width="20%" />
									<col width="80%" />
								</colgroup>
								<tbody class="listTable">
									<tr>
										<th scope="row" class="left">Name</th>
										<td class="left" id="name"></td>
									</tr>
									<tr>
										<th scope="row" class="left">UID</th>
										<td class="left" id="uid"></td>
									</tr>
									<tr>
										<th scope="row" class="left">Labels</th>
										<td class="box left" id="label"></td>
									</tr>
									<tr>
										<th scope="row" class="left">Annotations</th>
										<td class="left box" id="annot"></td>
									</tr>
									<tr>
										<th scope="row" class="left">Created time</th>
										<td class="left" id="time"></td>
									</tr>
								</tbody>
							</table>
						</div>
						<h4>Resource Info</h4>
						<div class="table_style01">
							<table>
								<caption>Resource Info</caption>
								<colgroup >
									<col width="20%" />
									<col width="80%" />
								</colgroup>
								<tbody class="resourceTable">
									<tr>
										<th scope="row" class="left">Pods CIDR</th>
										<td class="left" id="pods"></td>
									</tr>
									<tr>
										<th scope="row" class="left">Address</th>
										<td class="left" id="address"></td>
									</tr>
								</tbody>
							</table>
						</div>
						<h4>System Info</h4>
						<div class="table_style01">
							<table>
								<caption>System Info</caption>
								<colgroup >
									<col width="20%" />
									<col width="80%" />
								</colgroup>
								<tbody class="SystemTable">
									<tr>
										<th scope="row" class="left">Machine ID</th>
										<td class="left" id="machine"></td>
									</tr>
									<tr>
										<th scope="row" class="left">System UUID</th>
										<td class="left" id="suid"></td>
									</tr>
									<tr>
										<th scope="row" class="left">Boot ID</th>
										<td class="left" id="boot"></td>
									</tr>
									<tr>
										<th scope="row" class="left">Kernel version</th>
										<td class="left" id="kernel"></td>
									</tr>
									<tr>
										<th scope="row" class="left">OS image</th>
										<td class="left" id="os"></td>
									</tr>
									<tr>
										<th scope="row" class="left">Container runtime version</th>
										<td class="left" id="contain"></td>
									</tr>
									<tr>
										<th scope="row" class="left">Kubelet version</th>
										<td class="left" id="kubelet"></td>
									</tr>
									<tr>
										<th scope="row" class="left">Kube-proxy version</th>
										<td class="left" id="proxy"></td>
									</tr>
									<tr>
										<th scope="row" class="left">Operation system</th>
										<td class="left" id="operation"></td>
									</tr>
									<tr>
										<th scope="row" class="left">Architecture</th>
										<td class="left" id="architecture"></td>
									</tr>
								</tbody>
							</table>
						</div>
						<h4>Pods</h4>
						<div class="table_style01">
							<table>
								<caption>Pods</caption>
								<colgroup >
									<col width="20%" />
									<col width="20%" />
									<col width="26%" />
									<col width="8%" />
									<col width="8%" />
									<col width="18%" />
								</colgroup>
								<thead>
									<tr>
										<th scope="col">Name</th>
										<th scope="col">Namespaces</th>
										<th scope="col">Labels</th>
										<th scope="col">Status</th>
										<th scope="col">Restarts</th>
										<th scope="col">Created time</th>
									</tr>
								</thead>
								<tbody class="podTable">
								</tbody>
							</table>
						</div>
						<h4>Events</h4>
						<div class="table_style01">
							<table>
								<caption>Events</caption>
								<colgroup >
									<col width="20%" />
									<col width="20%" />
									<col width="16%" />
									<col width="8%" />
									<col width="18%" />
									<col width="18%" />
								</colgroup>
								<thead>
									<tr>
										<th scope="col">Message</th>
										<th scope="col">Source</th>
										<th scope="col">Sub-object</th>
										<th scope="col">Count</th>
										<th scope="col">First seen</th>
										<th scope="col">Last seen</th>
									</tr>
								</thead>
								<tbody class="eventTable">
								</tbody>
							</table>
						</div>
					</div>
					<!-- btn -->
					<div class="btn02">
						<div>
							<a href="nodes.html">이전</a>
						</div>
					</div>
				</article>
			</div>
			<!-- // Content -->
		</div>
		<!-- // container -->
		<!-- modal -->
		<div class="modal-wrap" style="display:none;">
			<div class="modal">
				<h5>삭제확인</h5>
				<p>리소스를 삭제하시겠습니까?</p>
				<button class="confirm" type="submit">삭제</button>
				<a class="close" href="javascript:;">닫기</a>
			</div>
		</div>
	</div>
	<script type="text/javascript" src="../resources/js/common.js"></script>
	<script type="text/javascript">
		window.onload = () => {

			func.init(0, 1);

			const nodeDetail = {
				init(){
					document.querySelector('header h3 ul').classList.toggle('hidden', true);

					// node 정보 조회
					func.loadData('GET', `${func.url}clusters/${sessionStorage.getItem('cluster')}/nodes/${sessionStorage.getItem('nodeName')}`, 'application/json', nodeDetail.draw);
					
					// pods 정보 조회
					func.loadData('GET', `${func.url}clusters/${sessionStorage.getItem('cluster')}/namespaces/${sessionStorage.getItem('nameSpace')}/pods/nodes/${sessionStorage.getItem('nodeName')}`, 'application/json', nodeDetail.podsList);
					
					// events 정보 조회
					func.loadData('GET', `${func.url}clusters/${sessionStorage.getItem('cluster')}/namespaces/${sessionStorage.getItem('nameSpace')}/events/resources/${sessionStorage.getItem('nodeName')}?type=node`, 'application/json', nodeDetail.eventsList);
				},

				draw(data){
					/*
					addresses: Array(2)
						0:
						address: "10.0.0.83"
						type: "InternalIP"
						1: {address: "paasta-cp-k8s-worker-003", type: "Hostname"}
					length: 2
					annotations:
						flannel.alpha.coreos.com/backend-data: "{"VtepMAC":"86:c2:9b:6d:f1:95"}"
						flannel.alpha.coreos.com/backend-type: "vxlan"
						flannel.alpha.coreos.com/kube-subnet-manager: "true"
						flannel.alpha.coreos.com/public-ip: "10.0.0.83"
						kubeadm.alpha.kubernetes.io/cri-socket: "/var/run/dockershim.sock"
						node.alpha.kubernetes.io/ttl: "0"
						volumes.kubernetes.io/controller-managed-attach-detach: "true"
					creationTimestamp: "2020-07-24 13:29:59"
					detailMessage: "정상적으로 처리 되었습니다."
					httpStatusCode: 200
					info:
						architecture: "amd64"
						bootID: "523eaf71-72c2-4e98-941b-50738d54cf8d"
						containerRuntimeVersion: "docker://19.3.6"
						kernelVersion: "5.4.0-1025-aws"
						kubeProxyVersion: "v1.17.1"
						kubeletVersion: "v1.17.1"
						machineID: "ec2d299760ea2429e07c1dd3f92d4cba"
						operatingSystem: "linux"
						osImage: "Ubuntu 18.04.5 LTS"
						systemUUID: "ec2d2997-60ea-2429-e07c-1dd3f92d4cba"
					labels:
						beta.kubernetes.io/arch: "amd64"
						beta.kubernetes.io/os: "linux"
						kubernetes.io/arch: "amd64"
						kubernetes.io/hostname: "paasta-cp-k8s-worker-003"
						kubernetes.io/os: "linux"
					name: "paasta-cp-k8s-worker-003"
					podsCIDR: "10.244.3.0/24"
					resultCode: "SUCCESS"
					resultMessage: "정상적으로 처리 되었습니다."
					uid: "9253b47d-1acd-4c00-9df1-b1863af89753"
					*/

					// Details data
					document.getElementById('name').innerText = data.name;
					document.getElementById('uid').innerText = data.uid;
					
					if(data.labels != '-'){
						for(var i=0; i<=Object.getOwnPropertyNames(data.labels).length-1; i++){
							var html = `<dl><dt>${Object.getOwnPropertyNames(data.labels)[i]}</dt><dd>${data.labels[Object.keys(data.labels)[i]]}</dd></dl>`;

							func.appendHtml(document.getElementById('label'), html, 'dl');
						};
					} else {
						var html = `<dl><dt>-</dt></dl>`;

						func.appendHtml(document.getElementById('label'), html, 'dl');
					}

					document.getElementById('time').innerText = data.creationTimestamp;

					if(data.annotations.length > 0){
						for(i=0; i<=data.annotations.length-1; i++){
							if(data.annotations[i].checkYn == 'Y'){
								var html = `<dl class="fly">
												<dt>${data.annotations[i].key}</dt>
												<dd> ${data.annotations[i].value}</dd>
											</dl>`;
							} else if(data.annotations[i].checkYn == 'N'){
								var html = `<dl>
												<dt>${data.annotations[i].key}</dt>
												<dd> ${data.annotations[i].value}</dd>
											</dl>`;
							} else {
								var html = `<dl>
												<dt>-</dt>
											</dl>`;
							};

							func.appendHtml(document.getElementById('annot'), html, 'dl');
						};
					};

					// Resource Info
					document.getElementById('pods').innerText = data.podsCIDR;
					
					var address = '';

					for(j=0; j<=data.addresses.length-1; j++){
						address += `${data.addresses[j].type} : ${data.addresses[j].address}\n`
					};
					
					document.getElementById('address').innerText = address;

					
					// System Info
					document.getElementById('machine').innerText = data.info.machineID;
					document.getElementById('suid').innerText = data.info.systemUUID;
					document.getElementById('boot').innerText = data.info.bootID;
					document.getElementById('kernel').innerText = data.info.kernelVersion;
					document.getElementById('os').innerText = data.info.osImage;
					document.getElementById('contain').innerText = data.info.containerRuntimeVersion;
					document.getElementById('kubelet').innerText = data.info.kubeletVersion;
					document.getElementById('proxy').innerText = data.info.kubeProxyVersion;
					document.getElementById('operation').innerText = data.info.operatingSystem;
					document.getElementById('architecture').innerText = data.info.architecture;
				},

				podsList(data){
					console.log(data);
					/*
					detailMessage: "정상적으로 처리 되었습니다."
					httpStatusCode: 200
					itemMetaData: {allItemCount: 8, remainingItemCount: 0}
					items: Array(8)
						0:
						creationTimestamp: "2020-12-08 11:18:08"
						labels: {app: "nginx", pod-template-hash: "56689dc4b8"}
						name: "nginx-test-56689dc4b8-z92cb"
						namespace: "jenkins-namespace"
						nodes: "paasta-cp-k8s-worker-003"
						podStatus: "Running"
						restarts: 0
					metadata: {selfLink: "/api/v1/pods", resourceVersion: "32949941"}
					resultCode: "SUCCESS"
					resultMessage: "정상적으로 처리 되었습니다."
					*/

					if(data.items.length > 0){
						for(var i=0; i<=data.items.length-1; i++){
							var html = `<tr>
								<td class="left">${data.items[i].name}</td>
								<td class="left">${data.items[i].namespace}</td>`;

							var label = '';
							
							if(data.items[i].labels != '-'){
								for(var j=0; j<=Object.getOwnPropertyNames(data.items[i].labels).length-1; j++){
									label += `<dl><dt>${Object.getOwnPropertyNames(data.items[i].labels)[j]}</dt><dd>${data.items[i].labels[Object.keys(data.items[i].labels)[j]]}</dd></dl>`;
								};
							} else {
								label = `<dl><dt>-</dt></dl>`;
							}

							html += `<td class="left box">${label}</td>`;

							html += `<td class="${data.items[i].podStatus.toLowerCase()}">${data.items[i].podStatus}</td>
								<td>${data.items[i].restarts}</td>
								<td>${data.items[i].creationTimestamp}</td>
							</tr>`;

							func.appendHtml(document.querySelector('.podTable'), html, 'tbody');
						};
					} else {
						var html = '<tr><td colspan="6">No Data.</td></tr>';

						func.appendHtml(document.querySelector('.podTable'), html, 'tbody');
					}
				},
				
				eventsList(data){
					/*
					detailMessage: "정상적으로 처리 되었습니다."
					httpStatusCode: 200
					items: Array(5)
						0:
						count: 1
						filePath: ""
						firstTimestamp: "2020-11-19T02:20:18Z"
						lastTimestamp: "2020-11-19T02:20:18Z"
						message: "System OOM encountered, victim process: java, pid: 1001"
						source: {component: "kubelet", host: "paasta-cp-k8s-worker-003"}
						1: {message: "System OOM encountered, victim process: java, pid: 20399", source: {…}, filePath: "", count: 1, firstTimestamp: "2020-11-19T02:21:11Z", …}
					resultCode: "SUCCESS"
					resultMessage: "정상적으로 처리 되었습니다."
					*/

					if(data.items.length > 0){
						for(var i=0; i<=data.items.length-1; i++){
							var html = `<tr>
								<td class="left">${data.items[i].message}</td>
								<td class="left">${data.items[i].source.component} ${data.items[i].source.host}</td>
								<td>${data.items[i].filePath}</td>
								<td>${data.items[i].count}</td>
								<td>${data.items[i].firstTimestamp}</td>
								<td>${data.items[i].lastTimestamp}</td>
							</tr>`;

							func.appendHtml(document.querySelector('.eventTable'), html, 'tbody');
						};
					} else {
						var html = '<tr><td colspan="6">No Data.</td></tr>';

						func.appendHtml(document.querySelector('.eventTable'), html, 'tbody');
					};
				},
			}

			nodeDetail.init();
		}
	</script>
</body>
</html>