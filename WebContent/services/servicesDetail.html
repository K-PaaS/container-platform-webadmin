<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>PaaS-TA Container</title>
	<link href="../resources/css/c3.min.css" rel="stylesheet" type="text/css" />
    <link href="../resources/css/layout.css" rel="stylesheet" type="text/css" />
</head>
<body>
	<div id="wrap">
		<!-- Header -->
		<header>
			<div>
				<!-- logo -->
				<h1>
					<a href="javascript:;"><img src="../resources/img/logo.png" alt="PaaS-TA 로고" /></a>
				</h1>
				<!-- menu -->
				<div>
					<!-- title -->
					<h3>
						<a href="javascript:;" class="nameTop">ALL</a>
						<ul class="nameSpace scroll02">
						</ul>
					</h3>
					<!-- member-menu -->
					<div>
						<a href="javascript:;" id="logout">로그아웃</a>
						<div>
							<a href="javascript:;">환경설정</a>
						</div>
					</div>
				</div>
			</div>
		</header>
		<!-- // Header -->
		<!-- container -->
		<div id="container">
			<!-- aside -->
			<aside>
				<nav>
					<ul>
						<li class="plus">
							<a href="javascript:;" class="dep01">Clusters</a>
							<ul class="sub">
								<li><a href="../clusters/namespaces.html">Namespaces</a></li>
								<li><a href="../clusters/nodes.html">Nodes</a></li>
							</ul>
						</li>
						<li class="plus">
							<a href="javascript:;" class="dep01">Workloads</a>
							<ul class="sub">
								<li><a href="../workloads/deployments.html">Deployments</a></li>
								<li><a href="../workloads/pods.html">Pods</a></li>
								<li><a href="../workloads/replicaSets.html">Replica Sets</a></li>
							</ul>
						</li>
						<li>
							<a href="../services/services.html" class="dep01">Services</a>
						</li>
						<li class="plus">
							<a href="javascript:;" class="dep01">Storages</a>
							<ul class="sub">
								<li><a href="../storages/persistentVolumes.html">Persistsnt Volumes</a></li>
								<li><a href="../storages/persistentVolumeClaims.html">Persistsnt Volume Claims</a></li>
								<li><a href="../storages/storageClasses.html">Storage Classes</a></li>
							</ul>
						</li>
						<li class="plus">
							<a href="javascript:;" class="dep01">Managements</a>
							<ul class="sub">
								<li><a href="../managements/users.html">Users</a></li>
								<li><a href="../managements/roles.html">Roles</a></li>
								<li><a href="../managements/resourceQuotas.html">Resource Quotas</a></li>
								<li><a href="../managements/limitRanges.html">Limit Ranges</a></li>
							</ul>
						</li>
					</ul>
				</nav>
			</aside>
			<!-- // aside -->
			<!-- Content -->
			<div id="content" class="sub-page">
				<article class="location">
					<ul>
						<li><a href="../index.html">Overview</a></li>
						<li><a href="services.html">Services</a></li>
					</ul>
				</article>
				<article class="base detail">
					<div class="notice">
						<h4>Details</h4>
						<div class="table_style01">
							<table>
								<caption>Details</caption>
								<colgroup >
									<col width="20%" />
									<col width="80%" />
								</colgroup>
								<tbody class="listTable">
									<tr>
										<th scope="row" class="left">Name</th>
										<td class="left" id="name"></td>
									</tr>
									<tr>
										<th scope="row" class="left">UID</th>
										<td class="left" id="uid"></td>
									</tr>
									<tr>
										<th scope="row" class="left">Namespaces</th>
										<td class="left" id="space"></td>
									</tr>
									<tr>
										<th scope="row" class="left">Labels</th>
										<td class="ellips left" id="label"></div>
										</td>
									</tr>
									<tr>
										<th scope="row" class="left">Annotations</th>
										<td class="left" id="annot"></td>
									</tr>
									<tr>
										<th scope="row" class="left">Created time</th>
										<td class="left" id="time"></td>
									</tr>
								</tbody>
							</table>
						</div>
						<h4>Resource Info</h4>
						<div class="table_style01">
							<table>
								<caption>Resource Info</caption>
								<colgroup >
									<col width="20%" />
									<col width="80%" />
								</colgroup>
								<tbody class="listTable">
									<tr>
										<th scope="row" class="left">Type</th>
										<td class="left" id="type"></td>
									</tr>
									<tr>
										<th scope="row" class="left">Clusters IP</th>
										<td class="left" id="ip"></td>
									</tr>
									<tr>
										<th scope="row" class="left">Session Affinity</th>
										<td class="left" id="affinity"></td>
									</tr>
									<tr>
										<th scope="row" class="left">Selector</th>
										<td class="left" id="selector"></td>
									</tr>
								</tbody>
							</table>
						</div>
						<h4>End Points</h4>
						<div class="table_style01">
							<table>
								<caption>End Points</caption>
								<colgroup >
									<col width="15%" />
									<col width="45%" />
									<col width="25%" />
									<col width="15%" />
								</colgroup>
								<thead>
									<tr>
										<th scope="col">Host</th>
										<th scope="col">Ports (Name, Port, Protocol)</th>
										<th scope="col">Nodes</th>
										<th scope="col">Ready</th>
									</tr>
								</thead>
								<tbody class="endList">
								</tbody>
							</table>
						</div>
						<h4>Pods</h4>
						<div class="table_style01">
							<table>
								<caption>Pods</caption>
								<colgroup >
									<col width="20%" />
									<col width="20%" />
									<col width="16%" />
									<col width="8%" />
									<col width="18%" />
									<col width="18%" />
								</colgroup>
								<thead>
									<tr>
										<th scope="col">Name</th>
										<th scope="col">Namespaces</th>
										<th scope="col">Labels</th>
										<th scope="col">Status</th>
										<th scope="col">Restarts</th>
										<th scope="col">Created time</th>
									</tr>
								</thead>
								<tbody class="podsList">
								</tbody>
							</table>
						</div>
						<h4>Events</h4>
						<div class="table_style01">
							<table>
								<caption>Events</caption>
								<colgroup >
									<col width="20%" />
									<col width="20%" />
									<col width="16%" />
									<col width="8%" />
									<col width="18%" />
									<col width="18%" />
								</colgroup>
								<thead>
									<tr>
										<th scope="col">Message</th>
										<th scope="col">Source</th>
										<th scope="col">Sub-object</th>
										<th scope="col">Count</th>
										<th scope="col">First seen</th>
										<th scope="col">Last seen</th>
									</tr>
								</thead>
								<tbody class="eventList">
								</tbody>
							</table>
						</div>
					</div>
					<!-- btn -->
					<div class="btn02">
						<button type="submit" id="delete">삭제</button>
						<div>
							<a href="javascript:;" id="modify" data-role="replicaSets">수정</a>
							<a href="services.html">이전</a>
						</div>
					</div>
				</article>
			</div>
			<!-- // Content -->
		</div>
		<!-- // container -->
	</div>
	<script type="text/javascript" src="../resources/js/c3.min.js"></script>
	<script type="text/javascript" src="../resources/js/common.js"></script>
	<script type="text/javascript">
		window.onload = () => {

			func.init(2, -1);

			const services = {
				init(){
					document.querySelector('header h3 ul').classList.toggle('hidden', true);
					
					// replica 정보 조회
					func.loadData('GET', `${func.url}clusters/${sessionStorage.getItem('cluster')}/namespaces/${sessionStorage.getItem('nameSpace')}/services/${sessionStorage.getItem('commonName')}`, 'application/json', services.draw);
				},

				draw(data){
					/*
					annotations: {nginx.services.targer2: "nginx2", nginx.services.target1: "nginx1"}
					clusterIP: "10.96.207.254"
					creationTimestamp: "2020-11-20 16:28:11"
					detailMessage: "정상적으로 처리 되었습니다."
					httpStatusCode: 200
					labels: {run: "my-nginx"}
					name: "cp-nginx-service"
					namespace: "1112-ns"
					resultCode: "SUCCESS"
					resultMessage: "정상적으로 처리 되었습니다."
					selector: {run: "my-nginx"}
					sessionAffinity: "None"
					type: "NodePort"
					uid: "4689939e-ad18-4cfd-847c-14f45f0b3695"
					*/

					// Details data
					document.getElementById('name').innerText = data.name;
					document.getElementById('uid').innerText = data.uid;
					document.getElementById('space').innerText = sessionStorage.getItem('nameSpace');
					document.getElementById('label').innerHTML = `<span>${JSON.stringify(data.labels)}</span><div class="scroll02">${JSON.stringify(data.labels)}</div>`;
					document.getElementById('time').innerText = data.creationTimestamp;

					if(data.annotations.length > 0){
						for(i=0; i<=data.annotations.length-1; i++){
							if(data.annotations[i].checkYn == 'Y'){
								var html = `<dl class="fly">
												<dt>${data.annotations[i].key}</dt>
												<dd> ${data.annotations[i].value}</dd>
											</dl>`;
							} else if(data.annotations[i].checkYn == 'N'){
								var html = `<dl>
												<dt>${data.annotations[i].key}</dt>
												<dd> ${data.annotations[i].value}</dd>
											</dl>`;
							} else {
								var html = `<dl>
												<dt>-</dt>
											</dl>`;
							};

							func.appendHtml(document.getElementById('annot'), html, 'dl');
						};
					};
					
					// Resource Info
					document.getElementById('type').innerText = data.type;
					document.getElementById('ip').innerText = data.clusterIP;
					document.getElementById('affinity').innerText = data.sessionAffinity;
					document.getElementById('selector').innerText = JSON.stringify(data.selector);
					//document.getElementById('address').innerText = JSON.stringify(data.addresses).replace(/\[{/gi, "").replace(/\}]/gi, "").replace(/\},{/gi, "\n");


					var matchLabel = JSON.stringify(data.selector).replace(/\"/gi, "").replace(/\{/gi, "").replace(/\}/gi, "").split(',');

					var replicaKey = '';
					
					for(var i=0; i<=matchLabel.length-1; i++){
						matchLabel[i] = matchLabel[i].split(':');
					};
					
					for(var j=0; j<=matchLabel.length-1; j++){
						if(j > 0) replicaKey += ',';
						replicaKey += ''+matchLabel[j][0];
						replicaKey += '='+matchLabel[j][1];
					};


					// endpoints 정보 조회
					func.loadData('GET', `${func.url}clusters/${sessionStorage.getItem('cluster')}/namespaces/${sessionStorage.getItem('nameSpace')}/endpoints/${data.name}`, 'application/json', services.endpoints);
					
					// pods 정보 조회
					func.loadData('GET', `${func.url}clusters/${sessionStorage.getItem('cluster')}/namespaces/${sessionStorage.getItem('nameSpace')}/pods/resources?selector=${replicaKey}&offset=0&limit=100`, 'application/json', services.podsList);
					
					// event 정보 조회
					func.loadData('GET', `${func.url}clusters/${sessionStorage.getItem('cluster')}/namespaces/${sessionStorage.getItem('nameSpace')}/events/resources/${data.uid}`, 'application/json', services.eventList);
				},

				endpoints(data){
					/*
					 "resultCode": "SUCCESS",
					"resultMessage": "정상적으로 처리 되었습니다.",
					"httpStatusCode": 200,
					"detailMessage": "정상적으로 처리 되었습니다.",
					"endpoints": [
						{
							"host": "10.244.1.129",                          // host
							"nodes": "paasta-cp-k8s-worker-001",     // nodes
							"ready": "True",                                  // ready
							"ports": [
								{
									"name": "http",                         // ports-name
									"port": 80,                               // ports-port
									"protocol": "TCP"                      // ports-protocol
								},
								{
									"name": "https",
									"port": 443,
									"protocol": "TCP"
								}
							]
						}, 
					]
					*/

					if(data.httpStatusCode == 404){
							var html = '<tr><td colspan="4">No Data.</td></tr>';

							func.appendHtml(document.querySelector('.endList'), html, 'tbody');
					} else {
						func.removeHtml(document.querySelector('.endList'));

						if(data.endpoints.length > 0){
							for(var i=0; i<=data.endpoints.length-1; i++){
								var html = `<tr><td class="left">${data.endpoints[i].host}</td><td class="ellips"><span>${JSON.stringify(data.endpoints[i].ports)}</span><div class="scroll02">${JSON.stringify(data.endpoints[i].ports)}</div></td><td><a href="javascript:;">${data.endpoints[i].nodes}</a></td><td>${data.endpoints[i].ready}</td></tr>`;

								func.appendHtml(document.querySelector('.endList'), html, 'tbody');
							};

							var nodeLink = document.querySelector('.endList').querySelectorAll('a');

							for(var i=0; i<=nodeLink.length-1; i++){
								nodeLink[i].addEventListener('click', (e) => {
									sessionStorage.setItem('nodeName', e.target.innerText);

									document.location.href = `${func.ui}clusters/nodesDetail.html`;
								}, false);
							}
						} else {
							var html = '<tr><td colspan="4">No Data.</td></tr>';

							func.appendHtml(document.querySelector('.endList'), html, 'tbody');
						};
					};
				},
				

				podsList(data){
					/*
					detailMessage: "정상적으로 처리 되었습니다."
					httpStatusCode: 200
					itemMetaData: {allItemCount: 1, remainingItemCount: 0}
					items: Array(1)
						0:
						creationTimestamp: "2020-11-17 19:22:19"
						labels: {app: "kjh-deployment", pod-template-hash: "5fd79d6475"}
						name: "kjh-deployment-test-wowo-5fd79d6475-stnpl"
						namespace: "cp-namespace"
						nodes: "paasta-cp-k8s-worker-001"
						podStatus: "Running"
						restarts: 0
						__proto__: Object
					metadata: {selfLink: "/api/v1/namespaces/cp-namespace/pods", resourceVersion: "28520166"}
					resultCode: "SUCCESS"
					resultMessage: "정상적으로 처리 되었습니다."
					*/
					
					func.removeHtml(document.querySelector('.podsList'));

					if(data.items.length > 0){
						for(var i=0; i<=data.items.length-1; i++){
							var html = `<tr><td class="left">${data.items[i].name}</td><td class="left">${data.items[i].namespace}</td><td class="ellips"><span>${JSON.stringify(data.items[i].labels)}</span><div class="scroll02">${JSON.stringify(data.items[i].labels)}</div></td><td>${data.items[i].podStatus}</td><td>${data.items[i].restarts}</td><td>${data.items[i].creationTimestamp}</td></tr>`;

							func.appendHtml(document.querySelector('.podsList'), html, 'tbody');
						};
					} else {
						var html = '<tr><td colspan="6">No Data.</td></tr>';

						func.appendHtml(document.querySelector('.podsList'), html, 'tbody');
					};
				},

				eventList(data){
					/*
					detailMessage: "정상적으로 처리 되었습니다."
					httpStatusCode: 200
					items: Array(3)
						0:
						count: 1
						filePath: ""
						firstTimestamp: "2020-11-20T06:02:57Z"
						lastTimestamp: "2020-11-20T06:02:57Z"
						message: "Created pod: cp-frontend-replicasets-t25k6"
						source: {component: "replicaset-controller", host: ""}
						1: {message: "Created pod: cp-frontend-replicasets-bq6k4", source: {…}, filePath: "", count: 1, firstTimestamp: "2020-11-20T06:02:57Z", …}
					resultCode: "SUCCESS"
					resultMessage: "정상적으로 처리 되었습니다."
					*/
					
					func.removeHtml(document.querySelector('.eventList'));

					if(data.items.length > 0){
						for(var i=0; i<=data.items.length-1; i++){
							var html = `<tr><td class="left">${data.items[i].message}</td><td class="left">${JSON.stringify(data.items[i].source)}</td><td>${data.items[i].filePath}</td><td>${data.items[i].count}</td><td>${data.items[i].firstTimestamp}</td><td>${data.items[i].lastTimestamp}</td></tr>`;

							func.appendHtml(document.querySelector('.eventList'), html, 'tbody');
						};
					} else {
						var html = '<tr><td colspan="6">No Data.</td></tr>';

						func.appendHtml(document.querySelector('.eventList'), html, 'tbody');
					};
					
					services.event();
				},

				event(){
					document.getElementById('delete').addEventListener('click', (e) => {
						func.alertPopup('DELETE', '삭제하시겠습니까?', true, '확인', services.delete);
					}, false);

					document.getElementById('modify').addEventListener('click', (e) => {
						// Resource yaml 정보 조회
						func.loadData('GET', `${func.url}clusters/${sessionStorage.getItem('cluster')}/namespaces/${sessionStorage.getItem('nameSpace')}/services/${sessionStorage.getItem('commonName')}/yaml`, 'application/json', func.modify);
					}, false);
				},

				delete(){
					func.saveData('DELETE', `${func.url}clusters/${sessionStorage.getItem('cluster')}/namespaces/${sessionStorage.getItem('nameSpace')}/services/${sessionStorage.getItem('commonName')}`, '', true, 'application/json', func.historyBack);
				},
			}

			services.init();
		}
	</script>
</body>
</html>